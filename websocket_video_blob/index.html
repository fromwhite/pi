<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Websocket echo fMp4</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
    <video id='v' autoplay controls width="80%"></video>
    <script>
        //canvasfinger
        window.getUUID = function (domain) {
            function bin2hex(s) {
                var i, l, o = '',
                    n;
                s += '';
                for (i = 0, l = s.length; i < l; i++) {
                    n = s.charCodeAt(i)
                        .toString(16);
                    o += n.length < 2 ? '0' + n : n;
                }
                return o;
            }

            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext("2d");
            ctx.font = "24px Arial";
            ctx.fillText("Hello Panda", 22, 33);
            ctx.moveTo(0, 60);
            ctx.lineTo(100, 60);
            ctx.stroke();
            var b64 = canvas.toDataURL().replace("data:image/png;base64,", "");
            var bin = atob(b64);
            var crc = bin2hex(bin.slice(-16, -12));

            canvas = null;
            return crc;
        }
    </script>
    <script>
        // var UUID = window.getUUID();
        document.addEventListener("DOMContentLoaded", main, false);

        function main() {
            var ws = new WebSocket("ws://" + document.domain + ":1999");
            ws.binaryType = 'arraybuffer';

            var mediaSource = new MediaSource();
            var buffer;
            var queue = [];
            var mimeCodec = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';

            var video = document.querySelector('#v');

            if ('MediaSource' in window && MediaSource.isTypeSupported(mimeCodec)) {
                video.src = window.URL.createObjectURL(mediaSource);
                //console.log(mediaSource.readyState); // closed
                mediaSource.addEventListener('sourceopen', function (e) {

                    buffer = mediaSource.addSourceBuffer(mimeCodec);

                    // buffer.addEventListener('update', function () {
                    //     if (queue.length > 0 && !buffer.updating) {
                    //         buffer.appendBuffer(queue.shift());
                    //     }
                    //     if (queue.length == 0 && !buffer.updating) {
                    //         mediaSource.endOfStream();
                    //     }
                    // });

                }, false);

                ws.addEventListener('message', function (e) {
                    // console.log(e)
                    if (typeof e.data !== 'string') {
                        if (buffer.updating || queue.length > 0) {
                            queue.push(e.data);
                        } else {
                            buffer.appendBuffer(e.data);
                        }

                    } else {
                        var action = '' + JSON.parse(e.data).action;
                        if (action == 'connected') {
                            ws.send(JSON.stringify({
                                action: "REQUESTSTREAM"
                            }))
                        }
                        if (action == 'end') {
                            // mediaSource.endOfStream();
                        }
                    }

                    buffer.addEventListener('updateend', function () {
                        // chrome66 禁止自动播放
                        //video.play();
                        //mediaSource.start(0);
                    })
                });
            } else {
                console.error('Unsupported MIME type or codec: ', mimeCodec);
            }
        }
    </script>
</body>

</html>